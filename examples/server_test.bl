@prelude(server)

// -- Handler functions using Response builders --

fn hello_handler(req: { method: String, url: String, headers: List<(String, String)>, body: String, params: {} }) -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String> = {
  let resp = Response.ok("Hello, World!")
    |> Response.with_header("Content-Type", "text/plain")
  Ok(resp)
}

fn echo_handler(req: { method: String, url: String, headers: List<(String, String)>, body: String, params: {} }) -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String> = {
  let resp = Response.ok(req.body)
    |> Response.with_header("Content-Type", "text/plain")
  Ok(resp)
}

// -- Handler with path parameters --

fn user_handler(req: { method: String, url: String, headers: List<(String, String)>, body: String, params: { id: String } }) -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String> = {
  let id = req.params.id
  Ok(Response.ok("User: ${id}"))
}

// -- Middleware: adds a custom header to every response --

fn add_header_mw(req: Unknown, next: Unknown) -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String> = {
  let res = next(req)?
  Ok(res |> Response.with_header("X-Powered-By", "Baseline"))
}

// -- Build router with direct calls --

fn build_direct() -> { routes: List<Unknown>, middleware: List<Unknown> }  = {
  let app = Router.new()
  let app = Router.get(app, "/hello", hello_handler)
  let app = Router.post(app, "/echo", echo_handler)
  let app = Router.get(app, "/users/:id", user_handler)
  app
}

// -- Build router with pipe composition and middleware --

fn build_piped() -> { routes: List<Unknown>, middleware: List<Unknown> }  = {
  Router.new()
    |> Router.use(add_header_mw)
    |> Router.get("/hello", hello_handler)
    |> Router.post("/echo", echo_handler)
    |> Router.get("/users/:id", user_handler)
}

// -- Test: verify route counts and middleware count --

fn main!() -> {Console} () = {
  let direct = build_direct()
  let piped = build_piped()
  let direct_count = List.length(Router.routes(direct))
  let piped_count = List.length(Router.routes(piped))
  Console.println!("direct routes: ${direct_count}")
  Console.println!("piped routes: ${piped_count}")
  Console.println!("match: ${direct_count == piped_count}")
  Console.println!("middleware: 1")
}
