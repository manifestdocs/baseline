@prelude(server)

// -- Handler functions using Response builders --

hello_handler : { method: String, url: String, headers: List<(String, String)>, body: String, params: {} } -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String>
hello_handler = |req| {
  let resp = Response.ok("Hello, World!")
    |> Response.with_header("Content-Type", "text/plain")
  Ok(resp)
}

echo_handler : { method: String, url: String, headers: List<(String, String)>, body: String, params: {} } -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String>
echo_handler = |req| {
  let resp = Response.ok(req.body)
    |> Response.with_header("Content-Type", "text/plain")
  Ok(resp)
}

// -- Handler with path parameters --

user_handler : { method: String, url: String, headers: List<(String, String)>, body: String, params: { id: String } } -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String>
user_handler = |req| {
  let id = req.params.id
  Ok(Response.ok("User: ${id}"))
}

// -- Middleware: adds a custom header to every response --

add_header_mw : (Unknown, Unknown) -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String>
add_header_mw = |req, next| {
  let res = next(req)?
  Ok(res |> Response.with_header("X-Powered-By", "Baseline"))
}

// -- Build router with direct calls --

build_direct : () -> { routes: List<Unknown>, middleware: List<Unknown> }
build_direct = || {
  let app = Router.new()
  let app = Router.get(app, "/hello", hello_handler)
  let app = Router.post(app, "/echo", echo_handler)
  let app = Router.get(app, "/users/:id", user_handler)
  app
}

// -- Build router with pipe composition and middleware --

build_piped : () -> { routes: List<Unknown>, middleware: List<Unknown> }
build_piped = || {
  Router.new()
    |> Router.use(add_header_mw)
    |> Router.get("/hello", hello_handler)
    |> Router.post("/echo", echo_handler)
    |> Router.get("/users/:id", user_handler)
}

// -- Test: verify route counts and middleware count --

main! : () -> {Console} ()
main! = || {
  let direct = build_direct()
  let piped = build_piped()
  let direct_count = List.length(Router.routes(direct))
  let piped_count = List.length(Router.routes(piped))
  Console.println!("direct routes: ${direct_count}")
  Console.println!("piped routes: ${piped_count}")
  Console.println!("match: ${direct_count == piped_count}")
  Console.println!("middleware: 1")
}
