@prelude(server)

// -- Middleware that wraps response body --

fn wrap_middleware(req: Unknown, next: Unknown) -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String> = {
  let res = next(req)?
  Ok(Response.ok("[${res.body}]"))
}

// -- Middleware that adds a prefix --

fn prefix_middleware(req: Unknown, next: Unknown) -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String> = {
  let res = next(req)?
  Ok(Response.ok("prefix:${res.body}"))
}

// -- Simple handler --

fn simple_handler(req: Unknown) -> {Http} Result<{ status: Int, headers: List<(String, String)>, body: String }, String> = {
  Ok(Response.ok("hello"))
}

// -- Build routers for testing --

fn no_middleware_router() -> { routes: List<Unknown>, middleware: List<Unknown> }  = {
  Router.new()
    |> Router.get("/test", simple_handler)
}

fn single_middleware_router() -> { routes: List<Unknown>, middleware: List<Unknown> }  = {
  Router.new()
    |> Router.use(wrap_middleware)
    |> Router.get("/test", simple_handler)
}

fn chained_middleware_router() -> { routes: List<Unknown>, middleware: List<Unknown> }  = {
  Router.new()
    |> Router.use(wrap_middleware)
    |> Router.use(prefix_middleware)
    |> Router.get("/test", simple_handler)
}

// -- Direct Router.use call (non-piped) --

fn direct_use_router() -> { routes: List<Unknown>, middleware: List<Unknown> }  = {
  let app = Router.new()
  let app = Router.use(app, wrap_middleware)
  let app = Router.get(app, "/test", simple_handler)
  app
}

fn main!() -> {Console} () = {
  let r0 = no_middleware_router()
  let r1 = single_middleware_router()
  let r2 = chained_middleware_router()
  let r3 = direct_use_router()

  Console.println!("no-mw routes: ${List.length(Router.routes(r0))}")
  Console.println!("single-mw routes: ${List.length(Router.routes(r1))}")
  Console.println!("chained-mw routes: ${List.length(Router.routes(r2))}")
  Console.println!("direct-use routes: ${List.length(Router.routes(r3))}")
}
