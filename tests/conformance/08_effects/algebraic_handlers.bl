@prelude(script)

// Conformance: tail-resumptive effect handlers with `handle body with { clauses }`

// Basic handler that intercepts println! and returns a value
test "handle intercepts effect call" = {
  let result = handle {
    Console.println!("hello")
    42
  } with {
    Console.println!(msg) -> resume(())
  }
  result == 42
}

// Handler that modifies the return value of an effect call
test "handle body returns final value" = {
  let result = handle {
    Console.println!("a")
    Console.println!("b")
    100 + 200
  } with {
    Console.println!(msg) -> resume(())
  }
  result == 300
}

// Pure body still works with handle
test "handle with pure body" = {
  let result = handle {
    1 + 2 + 3
  } with {
    Console.println!(msg) -> resume(())
  }
  result == 6
}

// Abort handler: returns early without calling resume
test "abort handler returns early" = {
  let result = handle {
    Console.println!("before abort")
    42
  } with {
    Console.println!(_msg) -> -1
  }
  result == -1
}

// Non-tail-resumptive: handler calls resume and does work after
test "handler with post-resume computation" = {
  let result = handle {
    Console.println!("hello")
    10
  } with {
    Console.println!(msg) -> {
      let rest = resume(())
      rest + 1
    }
  }
  result == 11
}

// Multiple effects with post-resume work
test "multiple effects with resume accumulation" = {
  let result = handle {
    Console.println!("a")
    Console.println!("b")
    0
  } with {
    Console.println!(msg) -> {
      let rest = resume(())
      rest + 1
    }
  }
  result == 2
}
